---
title: "Swadesh CDI: Exploratory analyses"
author: "Alvin Tan"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(mirt)
library(glue)
library(here)
library(plotly)
options(dplyr.summarise.inform = FALSE)
set.seed(42)
```

Calculate all theta values and plot by age; French (French) behaves weirdly with an unusual peak near 19mo.
```{r}
calc_theta <- function(xldf, languages, form='WS') {
  xx <- tibble()
  for(lang in languages) {
    # if(lang %in% c("Spanish (Mexican)", "French (French)")) next
    message(glue("Processing {lang}\r"))
    load(here(paste("data/",form,"/",lang,"_",form,"_data.Rdata", sep='')))
    ids <- d_prod |> rownames() |> as_tibble() |> 
      rename(data_id = value) |> 
      mutate(data_id = as.double(data_id)) |> 
      left_join(d_demo |> select(data_id, age), by = "data_id")
    
    thetas <- fscores(models[[lang]], method = "MAP")
    thetas <- cbind(ids, thetas) |> 
      mutate(language = lang)
    
    saveRDS(thetas, glue("data/thetas/{lang}.rds"))
    xx <- xx |> bind_rows(thetas)
  }
  return(xx)
}
```

```{r eval=F}
all_thetas <- calc_theta(xldf, languages)
saveRDS(all_thetas, "data/thetas/all_thetas.rds")
```

```{r}
all_thetas <- readRDS("data/thetas/all_thetas.rds")
```

```{r}
theta_plot <- ggplot(all_thetas, aes(x=age, y=G, col=language)) +
  theme_classic()

theta_plot +
  geom_point(alpha = .1, position="jitter") + 
  geom_smooth(method="loess", alpha=.5)
```

```{r}
# No scatter, but with hover tooltips
ggplotly(theta_plot + 
  geom_smooth(method="loess", se=F))
```


Compare Swadesh correlations with theta against random sublist correlations with theta
```{r}
run_swadesh_comparisons_theta <- function(xldf, languages, form='WS') {
  xx <- tibble()
  for(lang in languages) {
    # if(lang %in% c("Spanish (Mexican)", "French (French)")) next
    message(glue("Processing {lang}\r"))
    load(here(paste("data/",form,"/",lang,"_",form,"_data.Rdata", sep='')))
    swad_l <- subset(xldf, language==lang & is.element(uni_lemma, good_prod$uni_lemma)) 
    thetas <- all_thetas |> filter(language == lang)
    swad_cor = cor(thetas$G, rowSums(d_prod[,swad_l$item_id], na.rm=T), use = "complete.obs")
    
    rand_cors <- sapply(1:1000, \(x) {
      rand_inds = sample(1:ncol(d_prod), nrow(swad_l)) # N random words 
      rand_cor = cor(thetas$G, rowSums(d_prod[,rand_inds], na.rm=T), use = "complete.obs")
      rand_cor
    })
    
    xx <- xx |> bind_rows(tibble(language = lang, sublist = "Swadesh", 
                                 run = NA, cor = swad_cor, N = nrow(swad_l)))
    xx <- xx |> bind_rows(tibble(language = lang, sublist = "random", 
                                 run = 1:1000, cor = rand_cors, N = nrow(swad_l)))
    
    # xx <- xx |> bind_rows(tibble(language = lang, `Swadesh r` = swad_cor, 
    #                               `Rand r` = rand_cor, N = nrow(swad_l)))
    # d_demo, d_long, d_prod
  }
  return(xx)
}
```

```{r}
load(here("data/xling-WSprod-IRTparms.Rdata"))
load("data/multiling_2pl_age_WS_prod_fits.Rdata")
xldf <- xldf |> 
  mutate(uni_lemma = ifelse(uni_lemma=="NA", NA, uni_lemma)) |> 
  filter(!is.na(uni_lemma))
xldf[which(xldf$category=="descriptive_words (adjectives)"),]$category = "descriptive_words"
xldf[which(xldf$category=="outside_places"),]$category = "outside"
languages = names(coefs) |> sort()
low_data_langs <- c("Kiswahili", "Kigiriama", "Irish", "Persian", "Finnish",
                    "English (Irish)", "Spanish (Peruvian)", "Greek (Cypriot)")
languages <- setdiff(languages, low_data_langs)

pars <- xldf |> filter(!is.na(uni_lemma), !is.na(d)) 
ul <- sort(table(pars$uni_lemma)) 
short_list = ul[which(ul>9)]
prod_pars <-
  pars |> arrange(desc(language), desc(uni_lemma), desc(a1)) |> # get most discriminating uni_lemma per lang
  filter(is.element(uni_lemma, names(short_list))) |>
  select(uni_lemma, category, lexical_category, language, d) |>
  group_by(uni_lemma, language) |>
  slice(1) |> 
  pivot_wider(names_from = language, values_from = d)
prod_pars$sd = apply(prod_pars[,4:ncol(prod_pars)], 1, sd, na.rm=T)
prod_pars$numNAs = apply(prod_pars[,4:ncol(prod_pars)], 1, function(x) { sum(is.na(x)) })
med_d = median(prod_pars$sd, na.rm=T) # 1.17
sd_d = sd(prod_pars$sd, na.rm=T) # .44
good_prod <- prod_pars |> 
  filter(numNAs < 16) |>
  filter(sd < (med_d - .5*sd_d)) |> 
  arrange(numNAs)
```

```{r message=F}
xx <- run_swadesh_comparisons_theta(xldf, languages)
```

```{r}
xx_sum <- xx |> 
  group_by(language, sublist, N) |> 
  summarise(r = mean(cor))
```


```{r}
t.test(xx_sum |> filter(language != "French (French)", sublist == "Swadesh") |> pull(r),
       xx_sum |> filter(language != "French (French)", sublist == "random") |> pull(r),
       paired=T)
```


From the plot, we consider theta in range [-4, 4]. Plot Swadesh vs random test information over this theta range.
```{r message=F}
theta_range <- matrix(seq(-4,4,.01))
tinfo <- tibble()
form <- "WS"
for(lang in languages) {
  message(glue("Processing {lang}\r"))
  load(here(paste("data/",form,"/",lang,"_",form,"_data.Rdata", sep='')))
  xldf_l <- subset(xldf, language==lang)
  good_idx <- is.element(xldf_l$uni_lemma, good_prod$uni_lemma) |> which()
  
  swad_tinfo <- testinfo(models[[lang]], theta_range,
                         which.items = good_idx)
  
  rand_tinfos <- sapply(1:1000, \(x) {
    rand_idx = sample(1:nrow(xldf_l), length(good_idx))
    rand_tinfo <- testinfo(models[[lang]], theta_range,
                           which.items = rand_idx)
    rand_tinfo
  }) |> as_tibble()
  
  tinfo <- tinfo |> bind_rows(tibble(language = lang,
                                     theta = theta_range[,1],
                                     Swadesh = swad_tinfo) |> 
                                cbind(rand_tinfos) |> 
                                pivot_longer(cols = -c(language, theta),
                                             names_to = "run",
                                             values_to = "tinfo") |> 
                                mutate(sublist = ifelse(run == "Swadesh",
                                                        "Swadesh", "random")))
}

tinfo_sum <- tinfo |> 
  group_by(language, theta, sublist) |> 
  summarise(tinfo = mean(tinfo))

tinfo_plot <- ggplot(tinfo_sum |> filter(language != "French (French)"), 
       aes(x = theta, y = tinfo, col = language, lty = sublist)) +
  geom_line() +
  theme_classic()

ggplotly(tinfo_plot)
```

Compare total test information (area under curve). (Note that this value seems to be quite contingent on the specific random subset; probably good to run multiple simulations)
```{r}
total_tinfo <- tinfo_sum |> 
  group_by(language, sublist) |> 
  summarise(total_tinfo = sum(tinfo)) |> 
  filter(language != "French (French)")

t.test(total_tinfo |> filter(sublist == "Swadesh") |> pull(total_tinfo),
       total_tinfo |> filter(sublist == "random") |> pull(total_tinfo),
       paired=T)
```

Compare total test information only for tails (defined loosely as values at â‰¤20% of the peak of the curve). (Note that this value seems to be quite contingent on the specific random subset; probably good to run multiple simulations)
```{r}
tinfo_max <- tinfo_sum |> group_by(language, sublist) |> 
  summarise(max = max(tinfo))

tinfo_tails <- tinfo_sum |> 
  left_join(tinfo_max, by = c("language", "sublist")) |> 
  filter(tinfo <= 0.2 * max) |> 
  group_by(language, sublist) |> 
  summarise(tail_tinfo = sum(tinfo)) |> 
  filter(language != "French (French)")

t.test(tinfo_tails |> filter(sublist == "Swadesh") |> pull(tail_tinfo),
       tinfo_tails |> filter(sublist == "random") |> pull(tail_tinfo),
       paired=T)
```

Check whether test information peak (i.e., mode) is reliably lower in Swadesh than random
```{r}
tinfo_peaks <- tinfo_sum |> 
  left_join(tinfo_max |> mutate(is_max = 1),
            by = c("language", "sublist", "tinfo" = "max")) |> 
  filter(!is.na(is_max))

t.test(tinfo_peaks |> filter(sublist == "Swadesh") |> pull(theta),
       tinfo_peaks |> filter(sublist == "random") |> pull(theta),
       paired=T)
```

Visualisations of relationship between number of languages and item difficulty
```{r}
uni_all <- xldf %>% filter(uni_lemma!="NA", ! language %in% low_data_langs) %>%
  group_by(uni_lemma, category) %>%
  summarise(d_m=mean(d), a1_m=mean(a1), d_sd = sd(d), a1_sd = sd(a1), 
            n=n(), n_lang = length(unique(language)))

n_sd <- ggplot(uni_all, aes(x = n_lang, y = d_sd)) + 
  geom_point(alpha = .1) + 
  geom_smooth() + theme_classic()

n_m <- ggplot(uni_all, aes(x = n_lang, y = d_m)) + 
  geom_point(alpha = .1) + 
  geom_smooth() + theme_classic()

m_sd <- ggplot(uni_all, aes(x = d_sd, y = d_m)) + 
  geom_point(alpha = .1) + 
  geom_smooth() + theme_classic()
```

Random unilemmas as a baseline
```{r}
rand_idxs <- sapply(1:1000, \(x) {sample(1:nrow(ul), length(good_prod))})

run_swadesh_comparisons_theta_ul <- function(xldf, languages, form='WS') {
  xx <- tibble()
  for(lang in languages) {
    # if(lang %in% c("Spanish (Mexican)", "French (French)")) next
    message(glue("Processing {lang}\r"))
    load(here(paste("data/",form,"/",lang,"_",form,"_data.Rdata", sep='')))
    swad_l <- subset(xldf, language==lang & is.element(uni_lemma, good_prod$uni_lemma)) 
    thetas <- all_thetas |> filter(language == lang)
    swad_cor = cor(thetas$G, rowSums(d_prod[,swad_l$item_id], na.rm=T), use = "complete.obs")
    
    rand_cors <- sapply(1:1000, \(x) {
      rand_inds = rand_idxs[,x]
      rand_ul <- ul[rand_inds] |> as.data.frame() |> pull(Var1)
      rand_l <- subset(xldf, language==lang & is.element(uni_lemma, rand_ul)) 
      rand_cor = cor(thetas$G, rowSums(d_prod[,rand_l$item_id], na.rm=T), use = "complete.obs")
      rand_cor
    })
    
    xx <- xx |> bind_rows(tibble(language = lang, sublist = "Swadesh", 
                                 run = NA, cor = swad_cor, N = nrow(swad_l)))
    xx <- xx |> bind_rows(tibble(language = lang, sublist = "random", 
                                 run = 1:1000, cor = rand_cors, N = nrow(swad_l)))
    
    # xx <- xx |> bind_rows(tibble(language = lang, `Swadesh r` = swad_cor, 
    #                               `Rand r` = rand_cor, N = nrow(swad_l)))
    # d_demo, d_long, d_prod
  }
  return(xx)
}
```

```{r}
xx_ul <- run_swadesh_comparisons_theta_ul(xldf, languages)

xx_sum_ul <- xx_ul |> 
  group_by(language, sublist, N) |> 
  summarise(r = mean(cor))

t.test(xx_sum_ul |> filter(language != "French (French)", sublist == "Swadesh") |> pull(r),
       xx_sum_ul |> filter(language != "French (French)", sublist == "random") |> pull(r),
       paired=T)
```

```{r}
tinfo_ul <- tibble()
for(lang in languages) {
  message(glue("Processing {lang}\r"))
  load(here(paste("data/",form,"/",lang,"_",form,"_data.Rdata", sep='')))
  xldf_l <- subset(xldf, language==lang)
  good_idx <- is.element(xldf_l$uni_lemma, good_prod$uni_lemma) |> which()
  
  swad_tinfo <- testinfo(models[[lang]], theta_range,
                         which.items = good_idx)
  
  rand_tinfos <- sapply(1:1000, \(x) {
    rand_inds = rand_idxs[,x]
    rand_ul <- ul[rand_inds] |> as.data.frame() |> pull(Var1)
    rand_idx <- is.element(xldf_l$uni_lemma, rand_ul) |> which()
    rand_tinfo <- testinfo(models[[lang]], theta_range,
                           which.items = rand_idx)
    rand_tinfo
  }) |> as_tibble()
  
  tinfo_ul <- tinfo_ul |> bind_rows(tibble(language = lang,
                                           theta = theta_range[,1],
                                           Swadesh = swad_tinfo) |> 
                                      cbind(rand_tinfos) |> 
                                      pivot_longer(cols = -c(language, theta),
                                                   names_to = "run",
                                                   values_to = "tinfo") |> 
                                      mutate(sublist = ifelse(run == "Swadesh",
                                                              "Swadesh", "random")))
}

tinfo_sum_ul <- tinfo_ul |> 
  group_by(language, theta, sublist) |> 
  summarise(tinfo = mean(tinfo))
```

```{r}
total_tinfo_ul <- tinfo_sum_ul |> 
  group_by(language, sublist) |> 
  summarise(total_tinfo = sum(tinfo)) |> 
  filter(language != "French (French)")

t.test(total_tinfo_ul |> filter(sublist == "Swadesh") |> pull(total_tinfo),
       total_tinfo_ul |> filter(sublist == "random") |> pull(total_tinfo),
       paired=T)
```

```{r}
run_swadesh_comparisons_ul <- function(xldf, languages, swad_list, form='WS') {
  xx <- tibble()
  for(lang in languages) {
    load(here(paste("data/",form,"/",lang,"_",form,"_data.Rdata", sep='')))
    swad_l <- subset(xldf, language==lang & is.element(uni_lemma, good_prod$uni_lemma)) # 
    swad_cor = cor(rowSums(d_prod, na.rm=T), rowSums(d_prod[,swad_l$item_id], na.rm=T))
    
    rand_cors <- sapply(1:1000, \(x) {
      rand_inds = rand_idxs[,x]
      rand_ul <- ul[rand_inds] |> as.data.frame() |> pull(Var1)
      rand_l <- subset(xldf, language==lang & is.element(uni_lemma, rand_ul)) 
      rand_cor = cor(rowSums(d_prod, na.rm=T), rowSums(d_prod[,rand_l$item_id], na.rm=T))
      rand_cor
    })
    
    xx <- xx %>% bind_rows(tibble(language = lang, sublist = "Swadesh", 
                                 run = NA, cor = swad_cor, N = nrow(swad_l)))
    xx <- xx %>% bind_rows(tibble(language = lang, sublist = "random", 
                                 run = 1:1000, cor = rand_cors, N = nrow(swad_l)))
    # xx <- xx %>% bind_rows(tibble(language = lang, `Swadesh r` = swad_cor, 
    #                               `Rand r` = rand_cor, N = nrow(swad_l)))
    # d_demo, d_long, d_prod
  }
  return(xx)
}

```

```{r}
xx_ul_ss <- run_swadesh_comparisons_ul(xldf, languages)

xx_sum_ul_ss <- xx_ul_ss |> 
  group_by(language, sublist, N) |> 
  summarise(r = mean(cor))

t.test(xx_sum_ul_ss |> filter(language != "French (French)", sublist == "Swadesh") |> pull(r),
       xx_sum_ul_ss |> filter(language != "French (French)", sublist == "random") |> pull(r),
       paired=T)
```


Random unilemmas as a baseline, but weighted by form occurrence frequency
```{r}
rand_idxs_p <- sapply(1:1000, \(x) {sample(1:nrow(ul), length(good_prod), prob = ul)})

run_swadesh_comparisons_theta_ulp <- function(xldf, languages, form='WS') {
  xx <- tibble()
  for(lang in languages) {
    # if(lang %in% c("Spanish (Mexican)", "French (French)")) next
    message(glue("Processing {lang}\r"))
    load(here(paste("data/",form,"/",lang,"_",form,"_data.Rdata", sep='')))
    swad_l <- subset(xldf, language==lang & is.element(uni_lemma, good_prod$uni_lemma)) 
    thetas <- all_thetas |> filter(language == lang)
    swad_cor = cor(thetas$G, rowSums(d_prod[,swad_l$item_id], na.rm=T), use = "complete.obs")
    
    rand_cors <- sapply(1:1000, \(x) {
      rand_inds = rand_idxs_p[,x]
      rand_ul <- ul[rand_inds] |> as.data.frame() |> pull(Var1)
      rand_l <- subset(xldf, language==lang & is.element(uni_lemma, rand_ul)) 
      rand_cor = cor(thetas$G, rowSums(d_prod[,rand_l$item_id], na.rm=T), use = "complete.obs")
      rand_cor
    })
    
    xx <- xx |> bind_rows(tibble(language = lang, sublist = "Swadesh", 
                                 run = NA, cor = swad_cor, N = nrow(swad_l)))
    xx <- xx |> bind_rows(tibble(language = lang, sublist = "random", 
                                 run = 1:1000, cor = rand_cors, N = nrow(swad_l)))
    
    # xx <- xx |> bind_rows(tibble(language = lang, `Swadesh r` = swad_cor, 
    #                               `Rand r` = rand_cor, N = nrow(swad_l)))
    # d_demo, d_long, d_prod
  }
  return(xx)
}
```

```{r}
xx_ulp <- run_swadesh_comparisons_theta_ulp(xldf, languages)

xx_sum_ulp <- xx_ulp |> 
  group_by(language, sublist, N) |> 
  summarise(r = mean(cor))

t.test(xx_sum_ulp |> filter(language != "French (French)", sublist == "Swadesh") |> pull(r),
       xx_sum_ulp |> filter(language != "French (French)", sublist == "random") |> pull(r),
       paired=T)
```

```{r}
tinfo_ulp <- tibble()
for(lang in languages) {
  message(glue("Processing {lang}\r"))
  load(here(paste("data/",form,"/",lang,"_",form,"_data.Rdata", sep='')))
  xldf_l <- subset(xldf, language==lang)
  good_idx <- is.element(xldf_l$uni_lemma, good_prod$uni_lemma) |> which()
  
  swad_tinfo <- testinfo(models[[lang]], theta_range,
                         which.items = good_idx)
  
  rand_tinfos <- sapply(1:1000, \(x) {
    rand_inds = rand_idxs_p[,x]
    rand_ul <- ul[rand_inds] |> as.data.frame() |> pull(Var1)
    rand_idx <- is.element(xldf_l$uni_lemma, rand_ul) |> which()
    rand_tinfo <- testinfo(models[[lang]], theta_range,
                           which.items = rand_idx)
    rand_tinfo
  }) |> as_tibble()
  
  tinfo_ulp <- tinfo_ulp |> bind_rows(tibble(language = lang,
                                           theta = theta_range[,1],
                                           Swadesh = swad_tinfo) |> 
                                      cbind(rand_tinfos) |> 
                                      pivot_longer(cols = -c(language, theta),
                                                   names_to = "run",
                                                   values_to = "tinfo") |> 
                                      mutate(sublist = ifelse(run == "Swadesh",
                                                              "Swadesh", "random")))
}

tinfo_sum_ulp <- tinfo_ulp |> 
  group_by(language, theta, sublist) |> 
  summarise(tinfo = mean(tinfo))
```

```{r}
total_tinfo_ulp <- tinfo_sum_ulp |> 
  group_by(language, sublist) |> 
  summarise(total_tinfo = sum(tinfo)) |> 
  filter(language != "French (French)")

t.test(total_tinfo_ulp |> filter(sublist == "Swadesh") |> pull(total_tinfo),
       total_tinfo_ulp |> filter(sublist == "random") |> pull(total_tinfo),
       paired=T)
```

```{r}
run_swadesh_comparisons_ulp <- function(xldf, languages, swad_list, form='WS') {
  xx <- tibble()
  for(lang in languages) {
    load(here(paste("data/",form,"/",lang,"_",form,"_data.Rdata", sep='')))
    swad_l <- subset(xldf, language==lang & is.element(uni_lemma, good_prod$uni_lemma)) # 
    swad_cor = cor(rowSums(d_prod, na.rm=T), rowSums(d_prod[,swad_l$item_id], na.rm=T))
    
    rand_cors <- sapply(1:1000, \(x) {
      rand_inds = rand_idxs_p[,x]
      rand_ul <- ul[rand_inds] |> as.data.frame() |> pull(Var1)
      rand_l <- subset(xldf, language==lang & is.element(uni_lemma, rand_ul)) 
      rand_cor = cor(rowSums(d_prod, na.rm=T), rowSums(d_prod[,rand_l$item_id], na.rm=T))
      rand_cor
    })
    
    xx <- xx %>% bind_rows(tibble(language = lang, sublist = "Swadesh", 
                                 run = NA, cor = swad_cor, N = nrow(swad_l)))
    xx <- xx %>% bind_rows(tibble(language = lang, sublist = "random", 
                                 run = 1:1000, cor = rand_cors, N = nrow(swad_l)))
    # xx <- xx %>% bind_rows(tibble(language = lang, `Swadesh r` = swad_cor, 
    #                               `Rand r` = rand_cor, N = nrow(swad_l)))
    # d_demo, d_long, d_prod
  }
  return(xx)
}

```

```{r}
xx_ulp_ss <- run_swadesh_comparisons_ulp(xldf, languages)

xx_sum_ulp_ss <- xx_ulp_ss |> 
  group_by(language, sublist, N) |> 
  summarise(r = mean(cor))

t.test(xx_sum_ulp_ss |> filter(language != "French (French)", sublist == "Swadesh") |> pull(r),
       xx_sum_ulp_ss |> filter(language != "French (French)", sublist == "random") |> pull(r),
       paired=T)
```






Refactor and generalise Swadesh comparisons
```{r}
run_comparisons <- function(xldf, languages, swad_list, form = 'WS',
                            rand_method = "items", rand_comparisons = 1000,
                            metrics = c("sumscore_cor", 
                                        "theta_cor",
                                        "test_info")) {
  xx <- tibble()
  for(lang in languages) {
    message(glue("Processing {lang}\r"))
    load(here(paste("data/",form,"/",lang,"_",form,"_data.Rdata", sep='')))
    
    xldf_l <- xldf |> filter(language == lang)
    
    swad_idx <- is.element(xldf_l$uni_lemma, swad_list$uni_lemma) |> which()
    rand_idxs <- lapply(1:rand_comparisons, \(comp) {
      if (rand_method == "items") {
        return(sample(1:ncol(d_prod), nrow(swad_l)))
      }
      rand_uls <- case_when(
        rand_method == "unilemmas" ~ sample(1:nrow(ul), length(swad_list)),
        rand_method == "unilemmas_weighted" ~ sample(1:nrow(ul), length(swad_list), prob = ul),
        # TRUE ~ stop("Rand method not supported")
      )
      rand_idx <- is.element(xldf_l$uni_lemma, 
                             ul[rand_uls] |> as.data.frame() |> pull(Var1)) |> 
        which()
      rand_idx}
    )
    
    if ("sumscore_cor" %in% metrics) {
      swad_sscor <- cor(rowSums(d_prod, na.rm=T), rowSums(d_prod[,swad_idx], na.rm=T))
      rand_sscors <- sapply(1:rand_comparisons, \(comp) {
        rand_idx <- rand_idxs[[comp]]
        rand_sscor <- cor(rowSums(d_prod, na.rm=T), rowSums(d_prod[,rand_idx], na.rm=T))
        rand_sscor
      })
      
      sumscore_cor <- tibble(sublist = "Swadesh", run = NA, 
                             cor = swad_sscor, N = length(swad_idx)) |> 
        bind_rows(tibble(sublist = "random", run = 1:rand_comparisons, 
                         cor = rand_sscors, N = sapply(rand_idxs, length))) |> 
        mutate(language = lang, metric = "sumscore_cor")
      
      xx <- xx |> bind_rows(sumscore_cor)
    }
    
    if ("theta_cor" %in% metrics) {
      thetas <- readRDS(glue("data/thetas/{lang}.rds"))
      swad_thcor <- cor(thetas$G, rowSums(d_prod[,swad_idx], na.rm=T))
      rand_thcors <- sapply(1:rand_comparisons, \(comp) {
        rand_idx <- rand_idxs[[comp]]
        rand_thcor <- cor(thetas$G, rowSums(d_prod[,rand_idx], na.rm=T))
        rand_thcor
      })
      
      theta_cor <- tibble(sublist = "Swadesh", run = NA, 
                          cor = swad_thcor, N = length(swad_idx)) |> 
        bind_rows(tibble(sublist = "random", run = 1:rand_comparisons, 
                         cor = rand_thcors, N = sapply(rand_idxs, length))) |> 
        mutate(language = lang, metric = "theta_cor")
      
      xx <- xx |> bind_rows(theta_cor)
    }
    
    if ("test_info" %in% metrics) {
      swad_tinfo <- testinfo(models[[lang]], theta_range,
                             which.items = swad_idx) |> sum()
      rand_tinfos <- sapply(1:rand_comparisons, \(comp) {
        rand_idx <- rand_idxs[[comp]]
        rand_tinfo <- testinfo(models[[lang]], theta_range,
                               which.items = rand_idx)
        rand_tinfo
      }) |> colSums()
      
      test_info <- tibble(sublist = "Swadesh", run = NA, 
                          cor = swad_tinfo, N = length(swad_idx)) |> 
        bind_rows(tibble(sublist = "random", run = 1:rand_comparisons, 
                         cor = rand_tinfos, N = sapply(rand_idxs, length))) |> 
        mutate(language = lang, metric = "test_info")
      
      xx <- xx |> bind_rows(test_info)
    }
  }
  return(xx)
}
```

```{r}
xx_g <- run_comparisons(xldf, languages_tmp |> sort(), good_prod, rand_method = "unilemmas_weighted", rand_comparisons = 10)

```

